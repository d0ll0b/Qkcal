
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ± AI é£Ÿç‰©ç†±é‡åˆ†æå™¨ï¼ˆå¡å“‡ä¼Šç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg" href="./icon.svg">
  <link rel="apple-touch-icon" href="./icon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="./icon.svg">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(180deg, #FFF9E8, #FFE9F2);
      font-family: "Montserrat", "Noto Sans TC", sans-serif;
    }
    .cute-card {
      background: #ffffffee;
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 8px 0 #f5d1d1;
      border: 2px solid #ffb6c1;
      transition: 0.2s;
    }
    .cute-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 0 #f2b5b5;
    }
    .cute-btn {
      background: #ffb6c1;
      padding: 10px 16px;
      border-radius: 14px;
      font-weight: bold;
      color: #5a2a2a;
      transition: 0.15s;
    }
    .cute-btn:hover {
      background: #ff9fb0;
      transform: scale(1.05);
    }
    .loader {
      border: 4px solid #ffe4ec;
      border-top: 4px solid #ff7f9f;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-4">

  <div class="max-w-xl mx-auto">

    <!-- Title -->
    <h1 class="text-center text-3xl font-bold mb-4 text-pink-600">
      ğŸ± AI é£Ÿç‰©ç†±é‡åˆ†æå™¨
    </h1>
    <p class="text-center text-sm text-pink-700 mb-6">
      ä¸Šå‚³é¤é»ç…§ç‰‡ï¼ŒAI å¹«ä½ ä¼°ç®— kcalã€è›‹ç™½è³ªã€ç¢³æ°´ã€è„‚è‚ªï½ ğŸ’–
    </p>

    <!-- Upload card -->
    <div class="cute-card mb-6">
      <label
        class="flex flex-col items-center cursor-pointer"
        for="imageInput"
      >
        <span class="text-pink-600 mb-2 text-sm">é»æˆ‘æˆ–æ‹–æ›³åœ–ç‰‡ä¸Šå‚³</span>
        <span class="text-xs text-pink-400">æ”¯æ´ JPG / PNG</span>

        <input
          id="imageInput"
          type="file"
          accept="image/*"
          class="hidden"
        />
      </label>

      <div id="previewBox" class="hidden mt-4">
        <img id="previewImg" class="rounded-xl border-2 border-pink-300" />
      </div>

      <div class="flex justify-end mt-4 gap-3">
        <button id="clearBtn" class="cute-btn text-xs">æ¸…é™¤</button>
        <button id="analyzeBtn" class="cute-btn text-xs opacity-50" disabled>
          åˆ†æç†±é‡ ğŸ’¡
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingBox" class="hidden flex items-center text-pink-600 mb-4">
      <div class="loader"></div>
      <span>AI æ­£åœ¨åŠªåŠ›åˆ†æä¸­â€¦â€¦ğŸ˜‹</span>
    </div>

    <!-- Result -->
    <div id="resultCard" class="cute-card hidden">
      <h2 class="font-bold text-lg mb-2 text-pink-600">ğŸ™ åˆ†æçµæœ</h2>

      <div id="summary" class="grid grid-cols-2 gap-3 text-sm mb-4"></div>

      <div id="items" class="space-y-2 mb-4"></div>

      <div id="notes" class="text-xs text-pink-500"></div>
    </div>

  </div>

<script>
/** =========================
 *  Config / Storage
 * ========================= */
const LS_KEY = "ai_food_gemini_key";
let GEMINI_API_KEY = null;

function loadApiKey() {
  GEMINI_API_KEY = localStorage.getItem(LS_KEY);
  return GEMINI_API_KEY;
}
function saveApiKey(key) {
  localStorage.setItem(LS_KEY, key);
  GEMINI_API_KEY = key;
}
function clearApiKey() {
  localStorage.removeItem(LS_KEY);
  GEMINI_API_KEY = null;
}

/** =========================
 *  DOM refs
 * ========================= */
const imageInput = document.getElementById("imageInput");
const previewBox = document.getElementById("previewBox");
const previewImg = document.getElementById("previewImg");
const analyzeBtn = document.getElementById("analyzeBtn");
const clearBtn = document.getElementById("clearBtn");
const loadingBox = document.getElementById("loadingBox");
const resultCard = document.getElementById("resultCard");
const summary = document.getElementById("summary");
const items = document.getElementById("items");
const notes = document.getElementById("notes");

let fileObj = null;

/** =========================
 *  Security helpers (XSS-safe)
 * ========================= */
function clearChildren(el) {
  while (el.firstChild) el.removeChild(el.firstChild);
}
function el(tag, className) {
  const node = document.createElement(tag);
  if (className) node.className = className;
  return node;
}
function setText(node, text) {
  node.textContent = text == null ? "" : String(text);
}

/** =========================
 *  API Key Modal UI (cute)
 * ========================= */
function injectApiKeyButtonAndModal() {
  // Top-right button
  const container = document.querySelector(".max-w-xl.mx-auto");
  const topBar = el("div", "flex justify-end mb-3");
  const btn = el("button", "cute-btn text-xs");
  setText(btn, "ğŸ”‘ API Key");
  btn.type = "button";
  btn.addEventListener("click", () => openKeyModal());
  topBar.appendChild(btn);

  container.insertBefore(topBar, container.firstChild);

  // Modal overlay
  const overlay = el("div", "fixed inset-0 hidden items-center justify-center p-4");
  overlay.id = "keyModalOverlay";
  overlay.style.background = "rgba(0,0,0,0.35)";
  overlay.style.zIndex = "9999";

  // Modal card
  const modal = el("div", "cute-card w-full max-w-md");
  modal.setAttribute("role", "dialog");
  modal.setAttribute("aria-modal", "true");

  const title = el("div", "flex items-center justify-between mb-3");
  const h = el("h3", "font-bold text-lg text-pink-600");
  setText(h, "ğŸ” è¨­å®š Gemini API Key");
  const closeX = el("button", "text-pink-500 font-bold px-2");
  closeX.type = "button";
  setText(closeX, "âœ•");
  closeX.addEventListener("click", () => closeKeyModal());
  title.appendChild(h);
  title.appendChild(closeX);

  const hint = el("p", "text-xs text-pink-700 mb-3");
  setText(hint, "Key åªæœƒå­˜åœ¨ä½ çš„ç€è¦½å™¨ localStorageï¼ˆæœ¬ç¶²ç«™ä¸æœƒä¸Šå‚³æˆ–æ”¶é›† Keyï¼‰ã€‚å»ºè­°ä½¿ç”¨ã€Œé™åˆ¶å‹ API Keyï¼ˆHTTP referrerï¼‰ã€ä»¥é™ä½å¤–æ´©é¢¨éšªã€‚");

  const status = el("div", "text-xs mb-2");
  status.id = "keyStatus";

  const inputWrap = el("div", "mb-3");
  const label = el("label", "text-xs text-pink-600 block mb-1");
  setText(label, "Gemini API Key");
  const inputRow = el("div", "flex gap-2");
  const input = el("input", "w-full border-2 border-pink-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-pink-400");
  input.id = "keyInput";
  input.type = "password";
  input.autocomplete = "off";
  input.placeholder = "AIza...";

  const toggle = el("button", "cute-btn text-xs");
  toggle.type = "button";
  setText(toggle, "ğŸ‘€");
  toggle.addEventListener("click", () => {
    input.type = input.type === "password" ? "text" : "password";
  });

  inputRow.appendChild(input);
  inputRow.appendChild(toggle);
  inputWrap.appendChild(label);
  inputWrap.appendChild(inputRow);

  const actions = el("div", "flex justify-end gap-2 mt-2");
  const btnSave = el("button", "cute-btn text-xs");
  btnSave.type = "button";
  setText(btnSave, "å„²å­˜ âœ…");
  const btnClear = el("button", "cute-btn text-xs");
  btnClear.type = "button";
  setText(btnClear, "æ¸…é™¤ ğŸ§¹");
  const btnCancel = el("button", "cute-btn text-xs");
  btnCancel.type = "button";
  setText(btnCancel, "å–æ¶ˆ");

  btnCancel.addEventListener("click", () => closeKeyModal());

  btnSave.addEventListener("click", () => {
    const v = (input.value || "").trim();
    // åŸºæœ¬æ ¼å¼æª¢æŸ¥ï¼šGemini key é€šå¸¸æ˜¯ AIza...ï¼ˆä½†ä¸ä¿è­‰ï¼Œä¿å®ˆåªæª¢æŸ¥é•·åº¦/ç©ºï¼‰
    if (v.length < 20) {
      setKeyStatus("âŒ Key çœ‹èµ·ä¾†å¤ªçŸ­ï¼Œè«‹ç¢ºèªæ˜¯å¦æ­£ç¢º", "text-red-600");
      return;
    }
    saveApiKey(v);
    setKeyStatus("âœ… å·²å„²å­˜ï¼ˆlocalStorageï¼‰", "text-emerald-700");
    closeKeyModal();
  });

  btnClear.addEventListener("click", () => {
    clearApiKey();
    input.value = "";
    setKeyStatus("ğŸ§¹ å·²æ¸…é™¤", "text-pink-700");
  });

  actions.appendChild(btnCancel);
  actions.appendChild(btnClear);
  actions.appendChild(btnSave);

  modal.appendChild(title);
  modal.appendChild(hint);
  modal.appendChild(status);
  modal.appendChild(inputWrap);
  modal.appendChild(actions);

  // click outside to close
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) closeKeyModal();
  });

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  // init status
  refreshKeyStatus();
}

function setKeyStatus(msg, className) {
  const status = document.getElementById("keyStatus");
  if (!status) return;
  status.className = `text-xs mb-2 ${className || "text-pink-700"}`;
  setText(status, msg);
}

function refreshKeyStatus() {
  const key = loadApiKey();
  if (key) setKeyStatus("âœ… ç›®å‰ç‹€æ…‹ï¼šå·²å„²å­˜ API Key", "text-emerald-700");
  else setKeyStatus("âš  ç›®å‰ç‹€æ…‹ï¼šå°šæœªè¨­å®š API Key", "text-pink-700");
}

function openKeyModal() {
  const overlay = document.getElementById("keyModalOverlay");
  const input = document.getElementById("keyInput");
  refreshKeyStatus();
  if (input) {
    input.value = loadApiKey() || "";
    input.type = "password";
    input.focus();
  }
  overlay.classList.remove("hidden");
  overlay.classList.add("flex");
}

function closeKeyModal() {
  const overlay = document.getElementById("keyModalOverlay");
  overlay.classList.add("hidden");
  overlay.classList.remove("flex");
}

/** =========================
 *  Gemini call
 * ========================= */
async function callGemini(base64) {
  if (!GEMINI_API_KEY) {
    openKeyModal();
    throw new Error("å°šæœªè¨­å®š API Key");
  }

  const prompt = `
ä½ æ˜¯ä¸€ä½20å¹´ç¶“é©—çš„å°ˆæ¥­ç‡Ÿé¤Šå¸«ï¼Œè«‹å¾é¤é»ç…§ç‰‡ä¼°ç®—ç†±é‡èˆ‡ä¸‰å¤§ç‡Ÿé¤Šç´ ã€‚
è‹¥é¤é»ç‚ºå°ç£å¸¸è¦‹é£Ÿç‰©ï¼Œè«‹ä½¿ç”¨å°ç£å¸¸è¦‹ä»½é‡èˆ‡æ–™ç†æ–¹å¼ä¼°ç®—ã€‚
è«‹ã€Œåªè¼¸å‡ºåˆæ³• JSONã€ï¼Œä¸å¯åŠ ä»»ä½•èªªæ˜æ–‡å­—ã€‚

JSON æ ¼å¼å¦‚ä¸‹ï¼š
{
  "total_kcal": number,
  "total_protein_g": number,
  "total_carbs_g": number,
  "total_fat_g": number,
  "items": [
    {
      "name": string,
      "estimated_portion": string,
      "kcal": number,
      "protein_g": number,
      "carbs_g": number,
      "fat_g": number,
      "confidence": number
    }
  ],
  "confidence_overall": number,
  "notes": string
}
`.trim();

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType: "image/jpeg", data: base64 } }
          ]
        }],
        generationConfig: { temperature: 0.2 }
      })
    }
  );

  const rawText = await response.text();
  if (!response.ok) {
    console.log("Gemini error raw:", rawText);
    throw new Error(`Gemini API å¤±æ•—ï¼šHTTP ${response.status}`);
  }

  const json = JSON.parse(rawText);
  const text = json.candidates?.[0]?.content?.parts
    ?.map(p => p.text || "")
    ?.join("")
    ?.trim();

  if (!text) throw new Error("Gemini å›å‚³ç„¡æ–‡å­—å…§å®¹");

  // æ¸…ç† code fences
  const cleaned = text
    .replace(/^```json\s*/i, "")
    .replace(/^```\s*/i, "")
    .replace(/```$/i, "")
    .trim();

  return JSON.parse(cleaned);
}

/** =========================
 *  File helpers
 * ========================= */
function fileToBase64(file) {
  return new Promise((res) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result.split(",")[1]);
    reader.readAsDataURL(file);
  });
}

/** =========================
 *  UI event wiring
 * ========================= */
// upload preview
imageInput.addEventListener("change", (e) => {
  fileObj = e.target.files[0];
  if (!fileObj) return;

  previewImg.src = URL.createObjectURL(fileObj);
  previewBox.classList.remove("hidden");
  analyzeBtn.disabled = false;
  analyzeBtn.classList.remove("opacity-50");
  resultCard.classList.add("hidden");
});

// clear image
clearBtn.addEventListener("click", () => {
  imageInput.value = "";
  previewBox.classList.add("hidden");
  analyzeBtn.disabled = true;
  analyzeBtn.classList.add("opacity-50");
  resultCard.classList.add("hidden");
});

// analyze
analyzeBtn.addEventListener("click", async () => {
  if (!fileObj) return;

  loadingBox.classList.remove("hidden");
  clearChildren(summary);
  clearChildren(items);
  setText(notes, "");
  resultCard.classList.add("hidden");

  const base64 = await fileToBase64(fileObj);

  try {
    const raw = await callGemini(base64);
    renderResultSafe(raw);
  } catch (err) {
    console.log(err);
    resultCard.classList.remove("hidden");
    setText(notes, "âš  åˆ†æå¤±æ•—ï¼šè«‹ç¢ºèª API Keyã€æˆ–ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚");
  } finally {
    loadingBox.classList.add("hidden");
  }
});

/** =========================
 *  Safe render (no innerHTML)
 * ========================= */
function renderResultSafe(r) {
  resultCard.classList.remove("hidden");
  clearChildren(summary);
  clearChildren(items);
  setText(notes, "");

  // Summary cards
  const cards = [
    { label: "ç¸½ç†±é‡", value: `${r?.total_kcal ?? "â€”"} kcal` },
    { label: "è›‹ç™½è³ª", value: `${r?.total_protein_g ?? "â€”"} g` },
    { label: "ç¢³æ°´", value: `${r?.total_carbs_g ?? "â€”"} g` },
    { label: "è„‚è‚ª", value: `${r?.total_fat_g ?? "â€”"} g` },
  ];

  cards.forEach(c => {
    const box = el("div", "p-3 rounded-lg bg-pink-50 border border-pink-200");
    const l = el("div", "text-xs text-pink-600");
    const v = el("div", "text-lg font-bold");
    setText(l, c.label);
    setText(v, c.value);
    box.appendChild(l);
    box.appendChild(v);
    summary.appendChild(box);
  });

  // Items list
  const arr = Array.isArray(r?.items) ? r.items : [];
  arr.forEach(x => {
    const row = el("div", "p-3 rounded-xl bg-white border-2 border-pink-200");

    const name = el("div", "font-bold text-pink-700");
    setText(name, x?.name ?? "æœªå‘½åé£Ÿç‰©");

    const portion = el("div", "text-xs text-pink-500 mb-1");
    setText(portion, x?.estimated_portion ?? "");

    const meta = el("div", "text-xs");
    const conf = (typeof x?.confidence === "number") ? `${Math.round(x.confidence * 100)}%` : "â€”";
    setText(
      meta,
      `kcal: ${x?.kcal ?? "â€”"}ï½œè›‹ç™½è³ª: ${x?.protein_g ?? "â€”"} gï½œç¢³æ°´: ${x?.carbs_g ?? "â€”"} gï½œè„‚è‚ª: ${x?.fat_g ?? "â€”"} gï½œä¿¡å¿ƒåº¦: ${conf}`
    );

    row.appendChild(name);
    row.appendChild(portion);
    row.appendChild(meta);
    items.appendChild(row);
  });

  // Notes
  setText(notes, `å‚™è¨»ï¼š${r?.notes ?? "æœ¬çµæœç‚º AI æ¨ä¼°ï¼Œå¯èƒ½æœ‰ Â±20â€“30% èª¤å·®ï¼Œåƒ…ä¾›åƒè€ƒã€‚"}`);
}

/** =========================
 *  Init
 * ========================= */
injectApiKeyButtonAndModal();
loadApiKey(); // try load existing key

// å¦‚æœæœªè¨­å®š keyï¼Œç¬¬ä¸€æ¬¡å°±æé†’
if (!GEMINI_API_KEY) {
  // ä¸å¼·è¿«è·³å‡ºï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆç›´æ¥ openKeyModal();ï¼‰
  // openKeyModal();
}
</script>
